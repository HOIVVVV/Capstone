{% extends "base.html" %}
{% set active_page = 'upload' %}
{% block title %}í•˜ìˆ˜ê´€ë¡œ ì†ìƒ ë¶„ì„{% endblock %}

{% block content %}
<style>
    #result-images {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }
</style>

<!-- âœ… ì „ì²´ í˜ì´ì§€ Wrapper (Column ë°©í–¥) -->
<div style="min-height: 85vh; display: flex; flex-direction: column; align-items: center; background: #f9f9f9; padding-top: 40px;">

  <!-- ğŸ”¼ ìƒë‹¨: ì—…ë¡œë“œ ì¹´ë“œ + ì˜ìƒ ë¦¬ìŠ¤íŠ¸ -->
  <div style="
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  width: 100%;
  max-width: 1200px;
  padding: 0 20px;
  box-sizing: border-box;
">
    <!-- â¬…ï¸ ì—…ë¡œë“œ ì¹´ë“œ -->
    <div class="card"
         style="
        flex: 1 1 300px;   /* grow, shrink, basis */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        min-height: 600px;   /* âœ… ìµœì†Œ ë†’ì´ ì§€ì • */
        height: auto;         /* âœ… ë†’ì´ ìë™ ì¡°ì ˆ */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
     ">
      <h2 style="margin-bottom: 16px;">í•˜ìˆ˜ê´€ë¡œ ì†ìƒ ë¶„ì„</h2>
      <p class="text-muted" style="font-size: 16px; margin-bottom: 24px;">
        í•˜ìˆ˜ê´€ë¡œ ì˜ìƒì„ ì…ë ¥í•˜ê±°ë‚˜<br>ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”.
      </p>

      <!-- âœ… ì§„í–‰ ë°” UI -->
      <div id="progress-box" style="display: none; margin-bottom: 20px; width: 80%;">
        <div id="progress-text" style="margin-bottom: 8px;">ğŸ”„ ë¶„ì„ ì¤€ë¹„ ì¤‘...</div>
        <div style="width: 100%; height: 20px; background-color: #eee; border-radius: 10px; overflow: hidden;">
          <div id="progress-bar"
               style="width: 0%; height: 100%; background-color: #007bff; transition: width 0.5s;"></div>
        </div>
      </div>

      <!-- âœ… ì—…ë¡œë“œ input -->
      <label style="border: 2px dashed #007bff; border-radius: 10px;
              width: 80%; height: 200px;
              display: flex; justify-content: center; align-items: center;
              cursor: pointer; margin: auto;">
        <input type="file" id="videoInput" accept="video/*" multiple
              style="display: none;" onchange="handleFiles(this.files)">
        <span style="font-size: 50px; color: #007bff;">+</span>
      </label>

      <!-- âœ… ë¶„ì„ ì‹œì‘ ë²„íŠ¼ -->
      <button onclick="uploadVideo()"
              style="margin-top: 20px; margin-bottom: 40px; padding: 10px 20px;
                    background-color: #007bff; color: white; border: none; border-radius: 5px;">
        ë¶„ì„ ì‹œì‘
      </button>
    </div>

    <!-- â¡ï¸ ì—…ë¡œë“œëœ ì˜ìƒ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card"
         style="
        flex: 1 1 300px;
        min-height: 600px;   /* âœ… ìµœì†Œ ë†’ì´ ì§€ì • */
        height: auto;         /* âœ… ë†’ì´ ìë™ ì¡°ì ˆ */
        overflow-y: auto;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
     ">
      <h4 style="margin: 16px 0;">ì—…ë¡œë“œëœ ì˜ìƒ</h4>
      <ul id="fileList" style="list-style: none; padding: 0 16px; text-align: left;"></ul>
    </div>

  </div>

  <!-- ğŸ”½ í•˜ë‹¨: ë¶„ì„ ê²°ê³¼ ë°•ìŠ¤ (ì´ˆê¸° ë¹„ë…¸ì¶œ) -->
  <div id="result-box" style="display: none; width: 100%; max-width: 1200px; padding: 40px 20px;">

    <h4 style="margin-bottom: 20px; text-align: center;">ğŸ“¸ ë¶„ì„ ê²°ê³¼</h4>

    <!-- âœ… ê²°ê³¼ ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ -->
    <div id="result-grid"
     style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px; justify-items: center;">
    </div>


    <!-- âœ… í™•ì¸ ë²„íŠ¼ -->
    <div style="text-align: center; margin-top: 30px;">
      <button onclick="confirmResults()"
              style="padding: 10px 20px; background-color: #007bff; color: white;
                     border: none; border-radius: 5px;">
        âœ”ï¸ í™•ì¸
      </button>
    </div>

  </div>

</div>

<!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
<div id="predictImageModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0;
  width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center;">
  <img id="predictModalImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€"
    style="max-width: 90%; max-height: 90%; transform: scale(1); transition: transform 0.3s ease;" />
  <button onclick="closePredictModal()"
    style="position: absolute; top: 20px; right: 30px; font-size: 24px; color: white; background: none; border: none; cursor: pointer;">âœ–</button>
</div>


<!-- âœ… AJAX Upload + Progress Script -->
<script>
  let uploadedFiles = [];  // ì‚¬ìš©ìê°€ ì„ íƒí•œ íŒŒì¼ë“¤ ì €ì¥
  let pollingActive = false;

  function handleFiles(files) {
  const fileList = document.getElementById('fileList');
  uploadedFiles = [];  // ê¸°ì¡´ íŒŒì¼ ì´ˆê¸°í™”
  fileList.innerHTML = '';

  for (const file of files) {
    uploadedFiles.push(file);

    // ğŸ”„ íŒŒì¼ ì´ë¦„ + í¬ê¸° í‘œì‹œ
    const li = document.createElement('li');
    li.textContent = `ğŸ“ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
    li.style.marginBottom = '8px';
    fileList.appendChild(li);
  }

  document.getElementById('videoInput').value = '';
 }

 function uploadVideo() {
  // progress ì´ˆê¸°í™” í›„ ì‹¤ì œ ì—…ë¡œë“œ
  fetch("/reset_progress", { method: "POST" })
    .then(() => realUpload());
}

  function realUpload() {
  if (pollingActive) return;
  if (uploadedFiles.length === 0) {
    alert("ë¨¼ì € ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  // âœ… ì´ì „ ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”
  document.getElementById("result-grid").innerHTML = '';
  document.getElementById("result-box").style.display = "none";

  // ğŸ¯ ë§¨ ì• ì˜ìƒ ì œê±°í•˜ê³  ì €ì¥
  const file = uploadedFiles.shift();

  // âœ… ë¦¬ìŠ¤íŠ¸ UI ê°±ì‹ 
  handleFiles(uploadedFiles);

  pollingActive = true;

  const box = document.getElementById("progress-box");
  const text = document.getElementById("progress-text");
  const bar = document.getElementById("progress-bar");

  box.style.display = "block";
  text.innerText = "ğŸš€ ì˜ìƒ ì—…ë¡œë“œ ì¤‘...";
  bar.style.width = "0%";

  const formData = new FormData();
  formData.append("video[]", file);  // âœ… ë‹¨ì¼ ì˜ìƒë§Œ ì—…ë¡œë“œ

  fetch("/upload", {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        pollProgress();  // âœ… ì½œë°± ì—†ì´ ì§„í–‰
      } else {
        pollingActive = false;
        text.innerText = "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + result.message;
      }
    })
    .catch(err => {
      pollingActive = false;
      text.innerText = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ";
      console.error(err);
    });
}

  function pollProgress(onComplete = null) {
  fetch("/progress")
    .then(res => res.json())
    .then(data => {
      const text = document.getElementById("progress-text");
      const bar = document.getElementById("progress-bar");

      text.innerText = data.step;
      bar.style.width = data.percent + "%";

      if (data.done) {
        text.innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";
        pollingActive = false;

        fetch('/result_images')
          .then(res => res.json())
          .then(images => {
            renderResults(images);
            document.getElementById("result-box").style.display = "block";
          });

        if (typeof onComplete === "function") onComplete();  // âœ… ì™„ë£Œ í›„ ì½œë°± ì‹¤í–‰
        return;
      }

      setTimeout(() => pollProgress(onComplete), 1000);
    });
}

  function renderResults(images) {
  const resultGrid = document.getElementById('result-grid');
  resultGrid.innerHTML = '';

  for (const imgPath of images) {
    const label = extractLabelFromPath(imgPath);  // ì˜ˆ: Crack(95) ì¶”ì¶œ

    const card = document.createElement('div');
    card.style = `
      width: 100%;
      max-width: 200px;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 10px;
      background-color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    `;

    const img = document.createElement('img');
    img.src = `/static/${imgPath}`;
    img.style.width = "100%";
    img.style.borderRadius = '6px';
    img.style.marginBottom = '8px';
    img.dataset.path = imgPath;
    img.onclick = () => openPredictModal(img.src);

    const caption = document.createElement('div');
    caption.textContent = label;
    caption.style = `
  font-size: 13px;
  margin-bottom: 10px;
  text-align: center;
  word-break: break-word;
  white-space: pre-line;
`;

    const delBtn = document.createElement('button');
    delBtn.textContent = "ì‚­ì œ";
    delBtn.style = `
  margin-top: auto;
  margin-bottom: 8px;  /* âœ… ì•„ë˜ìª½ì— ì—¬ìœ  ì£¼ê¸° */
  padding: 5px 10px;
  background-color: #dc3545;
  color: white;
  border: none;
  border-radius: 5px;
`;
    delBtn.onclick = () => deleteImage(imgPath, card);

    card.appendChild(img);
    card.appendChild(caption);
    card.appendChild(delBtn);

    resultGrid.appendChild(card);
  }

  document.getElementById('result-box').style.display = 'block';
}

function extractLabelFromPath(path) {
  const classMap = {
    "1-1.ê· ì—´(Crack,CL),íŒŒì†(Broken-Pipe,BK)": 0,
    "1-2.í‘œë©´ì†ìƒ(Surface-Damage,SD),í† ì‚¬í‡´ì (Deposits-Silty,DS)": 1,
    "1-3.ì—°ê²°ê´€-ëŒì¶œ(Lateral-Protruding,LP)": 2,
    "1-4.ì´ìŒë¶€-ì†ìƒ(Joint-Faulty,JF)": 3,
  };

  // âœ… ì˜ì–´ ë¼ë²¨ ê¸°ì¤€ìœ¼ë¡œ í’€ ì´ë¦„ ë§¤í•‘
  const labelNameMap = {};
  Object.keys(classMap).forEach(key => {
    const match = key.match(/^[^\.]+\.(.+)$/);
    if (match) {
      const labelBlock = match[1];
      const subLabels = labelBlock.split(",");  // ë³µìˆ˜ ë¼ë²¨ ë¶„ë¦¬

      subLabels.forEach(sub => {
        const trimmed = sub.trim();
        if (trimmed) labelNameMap[trimmed] = key;
      });
    }
  });

  const results = [];

  // âœ… pathì—ì„œ (ìˆ«ì) ì•ê¹Œì§€ í…ìŠ¤íŠ¸ ì¶”ì¶œ
  const regex = /(.+?)\((\d+)\)/g;
  let match;
  while ((match = regex.exec(path)) !== null) {
    const raw = match[1].replace(/_/g, ' ').trim(); // ì˜ˆ: 'íŒŒì†(Broken-Pipe,BK)'
    const score = match[2];

    for (const key in labelNameMap) {
      if (raw.includes(key)) {
        const fullLabel = labelNameMap[key];  // ì˜ˆ: "1-1.ê· ì—´(Crack,CL),íŒŒì†(Broken-Pipe,BK)"
        const rawNames = fullLabel.split('.')[1];  // "ê· ì—´(Crack,CL),íŒŒì†(Broken-Pipe,BK)"
        const koreanNames = rawNames
          .split(',')
          .map(item => item.split('(')[0].trim())  // "ê· ì—´", "íŒŒì†"
          .join(',');

        results.push(`${koreanNames} (${score})`);
        break;
      }
    }
  }

  // âœ… ìˆœìœ„ëŒ€ë¡œ ì •ë ¬
  return results.map((val, idx) => `${idx + 1}ìˆœìœ„: ${val}`).join('\n');
}

function deleteImage(path, wrapperElement) {
  fetch('/delete_result_image', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path })
  }).then(res => {
    if (res.ok) {
      wrapperElement.remove();
    }
  });
}

function confirmResults() {
  const remainingPaths = Array.from(document.querySelectorAll('#result-grid img'))
    .map(img => img.dataset.path)
    .filter(Boolean);  // âœ… undefined ì œê±°

  fetch('/save_results_to_db', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ images: remainingPaths })
  }).then(res => {
    if (res.ok) {
      alert("âœ… ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      document.getElementById("result-box").style.display = "none";
    } else {
      alert("âŒ ì €ì¥ ì‹¤íŒ¨");
    }
  });
}

let zoom = 1;

function openPredictModal(src) {
  const modal = document.getElementById("predictImageModal");
  const modalImg = document.getElementById("predictModalImage");
  modalImg.src = src;
  zoom = 1;
  modalImg.style.transform = `scale(${zoom})`;
  modal.style.display = "flex";
}

function closePredictModal() {
    const modal = document.getElementById("predictImageModal");
  modal.style.display = "none";
}

// í™•ëŒ€/ì¶•ì†Œ (ë§ˆìš°ìŠ¤ íœ )
document.getElementById("predictImageModal").addEventListener("wheel", function (e) {
  e.preventDefault();
  if (e.deltaY < 0) {
    zoom += 0.1;
  } else {
    zoom = Math.max(1, zoom - 0.1);
  }
  document.getElementById("predictModalImage").style.transform = `scale(${zoom})`;
});

document.addEventListener('keydown', function (e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById("predictImageModal");
    if (modal.style.display === "flex") {
      closePredictModal();
    }s
  }
});
</script>
{% endblock %}
