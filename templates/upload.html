{% extends "base.html" %}
{% set active_page = 'upload' %}
{% block title %}í•˜ìˆ˜ê´€ë¡œ ì†ìƒ ë¶„ì„{% endblock %}

{% block content %}
<div style="min-height: 85vh; display: flex; justify-content: center; align-items: center; background: #f9f9f9;">
  <div style="display: flex; gap: 40px;">

    <!-- â¬…ï¸ ì—…ë¡œë“œ ì¹´ë“œ -->
    <div class="card"
         style="width: 450px; height: 550px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <h2 style="margin-bottom: 16px;">í•˜ìˆ˜ê´€ë¡œ ì†ìƒ ë¶„ì„</h2>
      <p class="text-muted" style="font-size: 16px; margin-bottom: 24px;">
        í•˜ìˆ˜ê´€ë¡œ ì˜ìƒì„ ì…ë ¥í•˜ê±°ë‚˜<br>ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”.
      </p>

      <!-- ì§„í–‰ ë°” ì˜ì—­ (ğŸ“Œ ì¶”ê°€ë¨) -->
      <div id="progress-box" style="display: none; margin-bottom: 20px; width: 80%;">
        <div id="progress-text" style="margin-bottom: 8px;">ğŸ”„ ë¶„ì„ ì¤€ë¹„ ì¤‘...</div>
        <div style="width: 100%; height: 20px; background-color: #eee; border-radius: 10px; overflow: hidden;">
          <div id="progress-bar"
               style="width: 0%; height: 100%; background-color: #007bff; transition: width 0.5s;"></div>
        </div>
      </div>

      <!-- ì—…ë¡œë“œ í¼ -->
      <form method="POST" action="{{ url_for('main.upload_video') }}" enctype="multipart/form-data" style="width: 100%;">
        {% if error %}
          <p style="color: red;">{{ error }}</p>
        {% endif %}
        {% if uploaded_filename %}
          <p style="color: green;">âœ… ë¶„ì„ ì™„ë£Œ: {{ uploaded_filename }}</p>
        {% endif %}

        <label style="border: 2px dashed #007bff; border-radius: 10px;
                      width: 80%; height: 200px;
                      display: flex; justify-content: center; align-items: center;
                      cursor: pointer; margin: auto;">
          <input type="file" name="video" accept="video/*"
                 style="display: none;" onchange="startAnalysis(); this.form.submit();">
          <span style="font-size: 50px; color: #007bff;">+</span>
        </label>
      </form>
    </div>

    <!-- â¡ï¸ ì—…ë¡œë“œ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card"
         style="width: 300px; height: 550px; overflow-y: auto;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); text-align: center;">
      <h4 style="margin-bottom: 16px;">ì—…ë¡œë“œëœ ì˜ìƒ</h4>

      {% if uploaded_filename %}
        <ul style="padding-left: 0; list-style: none; text-align: left; margin: 0 20px;">
          <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
            <span style="display: inline-block; max-width: 180px;
                         white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
              {{ uploaded_filename }}
            </span>
            <span style="float: right; background: #007bff; color: white; padding: 4px 8px; border-radius: 10px;">
              âœ…
            </span>
          </li>
        </ul>
      {% else %}
        <p class="text-muted" style="margin-top: 120px;">ì•„ì§ ì—…ë¡œë“œëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endif %}
    </div>

  </div>
</div>

<!-- ğŸ“Œ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script>
  function pollProgress() {
    fetch("/progress")
      .then(res => res.json())
      .then(data => {
        document.getElementById("progress-box").style.display = "block";
        document.getElementById("progress-text").innerText = data.step;
        document.getElementById("progress-bar").style.width = data.percent + "%";

        if (data.percent < 100) {
          setTimeout(pollProgress, 1000);
        } else {
          document.getElementById("progress-text").innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";
        }
      });
  }

  function startAnalysis() {
    document.getElementById("progress-box").style.display = "block";
    pollProgress();
  }
</script>
{% endblock %}
